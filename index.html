<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mischief Managed - Harry Potter Trivia</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --burgundy: #722F37;
            --gold: #D4AF37;
            --dark-brown: #3E2723;
            --light-cream: #F5F1E8;
            --green: #2E7D32;
            --red: #C62828;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, var(--dark-brown) 0%, #1a1a1a 100%);
            color: var(--light-cream);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gold);
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--light-cream);
            opacity: 0.9;
        }

        nav {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .nav-btn {
            font-family: 'Cinzel', serif;
            background: var(--burgundy);
            color: var(--gold);
            border: 2px solid var(--gold);
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-height: 44px;
            min-width: 100px;
        }

        .nav-btn:hover {
            background: var(--gold);
            color: var(--burgundy);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(212, 175, 55, 0.3);
        }

        .nav-btn.active {
            background: var(--gold);
            color: var(--burgundy);
            font-weight: 600;
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        .filters {
            background: rgba(62, 39, 35, 0.5);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--gold);
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            margin-bottom: 10px;
            display: block;
            font-size: 1.1rem;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(114, 47, 55, 0.6);
            color: var(--light-cream);
            border: 1px solid var(--burgundy);
            padding: 10px 16px;
            font-size: 0.95rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            min-height: 44px;
            font-family: 'Crimson Text', serif;
        }

        .filter-btn:hover {
            background: var(--burgundy);
            border-color: var(--gold);
        }

        .filter-btn.active {
            background: var(--gold);
            color: var(--burgundy);
            border-color: var(--gold);
            font-weight: 600;
        }

        .card-container {
            perspective: 1000px;
            margin: 40px auto;
            max-width: 600px;
        }

        .card {
            position: relative;
            width: 100%;
            min-height: 400px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            transform: translateZ(0);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            min-height: 400px;
            backface-visibility: hidden;
            border-radius: 16px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .card-front {
            background: linear-gradient(135deg, var(--burgundy) 0%, #5a1f28 100%);
            border: 3px solid var(--gold);
        }

        .card-back {
            background: linear-gradient(135deg, var(--dark-brown) 0%, #2a1810 100%);
            border: 3px solid var(--gold);
            transform: rotateY(180deg);
        }

        .badges {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .badge {
            font-family: 'Cinzel', serif;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.easy {
            background: #4CAF50;
            color: white;
        }

        .badge.medium {
            background: #FF9800;
            color: white;
        }

        .badge.hard {
            background: #F44336;
            color: white;
        }

        .badge.category {
            background: var(--gold);
            color: var(--burgundy);
        }

        .question-text {
            font-size: 1.5rem;
            line-height: 1.8;
            margin-bottom: 20px;
            color: var(--light-cream);
        }

        .answer-text {
            font-size: 1.4rem;
            line-height: 1.8;
            margin-bottom: 20px;
            color: var(--gold);
        }

        .source-text {
            font-style: italic;
            opacity: 0.9;
            font-size: 1rem;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--gold);
        }

        .source-text::before {
            content: "📖 Source: ";
            font-style: normal;
            opacity: 0.8;
        }

        .verify-link {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(212, 175, 55, 0.2);
            color: var(--gold);
            border: 1px solid var(--gold);
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .verify-link:hover {
            background: var(--gold);
            color: var(--burgundy);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(212, 175, 55, 0.3);
        }

        .tap-hint {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: auto;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .control-btn {
            font-family: 'Cinzel', serif;
            background: var(--burgundy);
            color: var(--gold);
            border: 2px solid var(--gold);
            padding: 14px 28px;
            font-size: 1.05rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-height: 48px;
            min-width: 120px;
        }

        .control-btn:hover {
            background: var(--gold);
            color: var(--burgundy);
            transform: translateY(-2px);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress {
            text-align: center;
            font-family: 'Cinzel', serif;
            color: var(--gold);
            margin-top: 20px;
            font-size: 1.1rem;
        }

        .quiz-score-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .quiz-btn {
            font-family: 'Cinzel', serif;
            padding: 18px 36px;
            font-size: 1.2rem;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            min-height: 60px;
            min-width: 160px;
            border: none;
            font-weight: 600;
        }

        .quiz-btn.correct {
            background: var(--green);
            color: white;
        }

        .quiz-btn.wrong {
            background: var(--red);
            color: white;
        }

        .quiz-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .results-screen {
            background: rgba(62, 39, 35, 0.8);
            padding: 40px;
            border-radius: 16px;
            border: 2px solid var(--gold);
            max-width: 700px;
            margin: 0 auto;
        }

        .results-score {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            color: var(--gold);
            text-align: center;
            margin-bottom: 30px;
        }

        .results-list {
            margin: 30px 0;
        }

        .result-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .result-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .result-question {
            flex-grow: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: rgba(62, 39, 35, 0.6);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid var(--gold);
            text-align: center;
        }

        .stat-value {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--gold);
            margin: 15px 0;
        }

        .stat-label {
            font-size: 1.1rem;
            color: var(--light-cream);
            opacity: 0.9;
        }

        .stat-breakdown {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: left;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--light-cream);
            opacity: 0.8;
        }

        .empty-state h2 {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            margin-bottom: 15px;
            font-size: 2rem;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .card-face {
                min-height: 350px;
                padding: 30px 20px;
            }

            .question-text, .answer-text {
                font-size: 1.2rem;
            }

            .control-btn {
                padding: 12px 20px;
                font-size: 1rem;
                min-width: 100px;
            }

            .quiz-btn {
                padding: 16px 28px;
                font-size: 1.1rem;
                min-width: 140px;
            }

            .results-score {
                font-size: 2.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.6rem;
            }

            .nav-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
                min-width: 80px;
            }

            .card-face {
                min-height: 320px;
                padding: 25px 15px;
            }

            .question-text, .answer-text {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>⚡ Mischief Managed ⚡</h1>
            <p class="subtitle">Test Your Wizarding World Knowledge</p>
            <nav>
                <button class="nav-btn active" data-mode="browse">Browse</button>
                <button class="nav-btn" data-mode="quiz">Quiz</button>
                <button class="nav-btn" data-mode="review">Review</button>
                <button class="nav-btn" data-mode="stats">Statistics</button>
            </nav>
        </header>

        <div id="browse-mode" class="mode-content active">
            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">Difficulty:</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="difficulty" data-value="all">All</button>
                        <button class="filter-btn" data-filter="difficulty" data-value="easy">Easy</button>
                        <button class="filter-btn" data-filter="difficulty" data-value="medium">Medium</button>
                        <button class="filter-btn" data-filter="difficulty" data-value="hard">Hard</button>
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Category:</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="category" data-value="all">All</button>
                        <button class="filter-btn" data-filter="category" data-value="Spells">Spells</button>
                        <button class="filter-btn" data-filter="category" data-value="Potions">Potions</button>
                        <button class="filter-btn" data-filter="category" data-value="Characters">Characters</button>
                        <button class="filter-btn" data-filter="category" data-value="Locations">Locations</button>
                        <button class="filter-btn" data-filter="category" data-value="History">History</button>
                        <button class="filter-btn" data-filter="category" data-value="Creatures">Creatures</button>
                        <button class="filter-btn" data-filter="category" data-value="Quidditch">Quidditch</button>
                        <button class="filter-btn" data-filter="category" data-value="Hogwarts">Hogwarts</button>
                    </div>
                </div>
            </div>

            <div class="card-container">
                <div class="card" id="flashcard">
                    <div class="card-face card-front">
                        <div class="badges">
                            <span class="badge category" id="card-category"></span>
                            <span class="badge" id="card-difficulty"></span>
                        </div>
                        <p class="question-text" id="card-question"></p>
                        <p class="tap-hint">Tap to reveal answer</p>
                    </div>
                    <div class="card-face card-back">
                        <p class="answer-text" id="card-answer"></p>
                        <p class="source-text" id="card-source"></p>
                        <a href="#" class="verify-link" id="verify-browse" target="_blank" rel="noopener noreferrer">
                            🔍 Verify on Google
                        </a>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn" id="prev-btn">← Previous</button>
                <button class="control-btn" id="shuffle-btn">Shuffle</button>
                <button class="control-btn" id="next-btn">Next →</button>
            </div>

            <p class="progress" id="progress-text"></p>
        </div>

        <div id="quiz-mode" class="mode-content">
            <div id="quiz-start">
                <div class="filters">
                    <h2 style="font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 15px; text-align: center;">
                        Ready for a Quiz?
                    </h2>
                    <p style="text-align: center; margin-bottom: 25px; opacity: 0.9;">
                        Select your preferences and test yourself with 10 random questions!
                    </p>

                    <div class="filter-group">
                        <span class="filter-label">Difficulty:</span>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-quiz-filter="difficulty" data-value="all">All</button>
                            <button class="filter-btn" data-quiz-filter="difficulty" data-value="easy">Easy</button>
                            <button class="filter-btn" data-quiz-filter="difficulty" data-value="medium">Medium</button>
                            <button class="filter-btn" data-quiz-filter="difficulty" data-value="hard">Hard</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Category:</span>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-quiz-filter="category" data-value="all">All</button>
                            <button class="filter-btn" data-quiz-filter="category" data-value="Spells">Spells</button>
                            <button class="filter-btn" data-quiz-filter="category" data-value="Potions">Potions</button>
                            <button class="filter-btn" data-quiz-filter="category" data-value="Characters">Characters</button>
                            <button class="filter-btn" data-quiz-filter="category" data-value="Locations">Locations</button>
                            <button class="filter-btn" data-quiz-filter="category" data-value="History">History</button>
                            <button class="filter-btn" data-quiz-filter="category" data-value="Creatures">Creatures</button>
                            <button class="filter-btn" data-quiz-filter="category" data-value="Quidditch">Quidditch</button>
                            <button class="filter-btn" data-quiz-filter="category" data-value="Hogwarts">Hogwarts</button>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 25px;">
                        <p style="opacity: 0.8; margin-bottom: 15px;" id="quiz-available-count"></p>
                        <button class="control-btn" id="start-quiz-btn">Start Quiz</button>
                    </div>
                </div>
            </div>

            <div id="quiz-active" style="display: none;">
                <div class="card-container">
                    <div class="card" id="quiz-card">
                        <div class="card-face card-front">
                            <div class="badges">
                                <span class="badge category" id="quiz-category"></span>
                                <span class="badge" id="quiz-difficulty"></span>
                            </div>
                            <p class="question-text" id="quiz-question"></p>
                            <p class="tap-hint">Tap to reveal answer</p>
                        </div>
                        <div class="card-face card-back">
                            <p class="answer-text" id="quiz-answer"></p>
                            <p class="source-text" id="quiz-source"></p>
                            <a href="#" class="verify-link" id="verify-quiz" target="_blank" rel="noopener noreferrer">
                                🔍 Verify on Google
                            </a>
                        </div>
                    </div>
                </div>

                <div class="quiz-score-buttons">
                    <button class="quiz-btn correct" id="correct-btn">✓ Got it right</button>
                    <button class="quiz-btn wrong" id="wrong-btn">✗ Got it wrong</button>
                </div>

                <p class="progress" id="quiz-progress"></p>
            </div>

            <div id="quiz-results" style="display: none;"></div>
        </div>

        <div id="review-mode" class="mode-content"></div>

        <div id="stats-mode" class="mode-content"></div>
    </div>

    <script>
        let allQuestions = [];
        let currentQuestions = [];
        let currentIndex = 0;
        let filters = { difficulty: 'all', category: 'all' };
        let quizFilters = { difficulty: 'all', category: 'all' };

        let quizQuestions = [];
        let quizIndex = 0;
        let quizScore = 0;
        let wrongAnswers = [];

        const STORAGE_KEYS = {
            WRONG_ANSWERS: 'hp_wrong_answers',
            QUIZ_HISTORY: 'hp_quiz_history'
        };

        async function loadQuestions() {
            try {
                const response = await fetch('trivia_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allQuestions = data.questions;

                if (!allQuestions || allQuestions.length === 0) {
                    throw new Error('No questions found in trivia_data.json');
                }

                applyFilters();
                renderBrowseCard();
                updateQuizAvailableCount();
                console.log(`Successfully loaded ${allQuestions.length} questions`);
            } catch (error) {
                console.error('Error loading questions:', error);
                const errorMsg = `Failed to load trivia questions.\n\nError: ${error.message}\n\nMake sure:\n1. You're running a local server (python3 -m http.server 8000)\n2. trivia_data.json is in the same directory\n3. Check the browser console for details`;
                alert(errorMsg);

                document.getElementById('card-question').textContent = 'Error loading questions';
                document.getElementById('progress-text').textContent = 'Please check the console for details';
            }
        }

        function applyFilters() {
            currentQuestions = allQuestions.filter(q => {
                const difficultyMatch = filters.difficulty === 'all' || q.difficulty === filters.difficulty;
                const categoryMatch = filters.category === 'all' || q.category === filters.category;
                return difficultyMatch && categoryMatch;
            });
            currentIndex = 0;
        }

        function renderBrowseCard() {
            if (currentQuestions.length === 0) {
                document.getElementById('card-question').textContent = 'No questions match your filters';
                document.getElementById('card-category').textContent = '';
                document.getElementById('card-difficulty').textContent = '';
                document.getElementById('card-answer').textContent = '';
                document.getElementById('card-source').textContent = '';
                document.getElementById('progress-text').textContent = 'No questions available';
                return;
            }

            const q = currentQuestions[currentIndex];
            document.getElementById('card-question').textContent = q.question;
            document.getElementById('card-category').textContent = q.category;
            document.getElementById('card-difficulty').textContent = q.difficulty;
            document.getElementById('card-difficulty').className = `badge ${q.difficulty}`;
            document.getElementById('card-answer').textContent = q.answer;
            document.getElementById('card-source').textContent = q.source;
            document.getElementById('progress-text').textContent =
                `Question ${currentIndex + 1} of ${currentQuestions.length}`;

            document.getElementById('flashcard').classList.remove('flipped');
        }

        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                const filterType = btn.dataset.filter;
                const value = btn.dataset.value;

                document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(b =>
                    b.classList.remove('active'));
                btn.classList.add('active');

                filters[filterType] = value;
                applyFilters();
                renderBrowseCard();
            });
        });

        document.querySelectorAll('[data-quiz-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                const filterType = btn.dataset.quizFilter;
                const value = btn.dataset.value;

                document.querySelectorAll(`[data-quiz-filter="${filterType}"]`).forEach(b =>
                    b.classList.remove('active'));
                btn.classList.add('active');

                quizFilters[filterType] = value;
                updateQuizAvailableCount();
            });
        });

        function updateQuizAvailableCount() {
            const filtered = allQuestions.filter(q => {
                const difficultyMatch = quizFilters.difficulty === 'all' || q.difficulty === quizFilters.difficulty;
                const categoryMatch = quizFilters.category === 'all' || q.category === quizFilters.category;
                return difficultyMatch && categoryMatch;
            });

            const count = filtered.length;
            const countText = count >= 10
                ? `${count} questions available`
                : `Only ${count} questions available - quiz will have ${count} questions`;

            document.getElementById('quiz-available-count').textContent = countText;
        }

        document.getElementById('flashcard').addEventListener('click', function() {
            this.classList.toggle('flipped');
        });

        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentQuestions.length > 0) {
                currentIndex = (currentIndex - 1 + currentQuestions.length) % currentQuestions.length;
                renderBrowseCard();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentQuestions.length > 0) {
                currentIndex = (currentIndex + 1) % currentQuestions.length;
                renderBrowseCard();
            }
        });

        document.getElementById('shuffle-btn').addEventListener('click', () => {
            for (let i = currentQuestions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentQuestions[i], currentQuestions[j]] = [currentQuestions[j], currentQuestions[i]];
            }
            currentIndex = 0;
            renderBrowseCard();
        });

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;

                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                document.querySelectorAll('.mode-content').forEach(m => m.classList.remove('active'));
                document.getElementById(`${mode}-mode`).classList.add('active');

                if (mode === 'review') renderReviewMode();
                if (mode === 'stats') renderStatsMode();
            });
        });

        document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);

        function startQuiz() {
            const filtered = allQuestions.filter(q => {
                const difficultyMatch = quizFilters.difficulty === 'all' || q.difficulty === quizFilters.difficulty;
                const categoryMatch = quizFilters.category === 'all' || q.category === quizFilters.category;
                return difficultyMatch && categoryMatch;
            });

            if (filtered.length === 0) {
                alert('No questions match your selected filters. Please adjust your selection.');
                return;
            }

            const shuffled = [...filtered].sort(() => Math.random() - 0.5);
            const quizLength = Math.min(10, filtered.length);
            quizQuestions = shuffled.slice(0, quizLength);
            quizIndex = 0;
            quizScore = 0;
            wrongAnswers = [];

            document.getElementById('quiz-start').style.display = 'none';
            document.getElementById('quiz-active').style.display = 'block';
            renderQuizCard();
        }

        function renderQuizCard() {
            const q = quizQuestions[quizIndex];
            document.getElementById('quiz-question').textContent = q.question;
            document.getElementById('quiz-category').textContent = q.category;
            document.getElementById('quiz-difficulty').textContent = q.difficulty;
            document.getElementById('quiz-difficulty').className = `badge ${q.difficulty}`;
            document.getElementById('quiz-answer').textContent = q.answer;
            document.getElementById('quiz-source').textContent = q.source;
            document.getElementById('quiz-progress').textContent =
                `Question ${quizIndex + 1}/10 | Score: ${quizScore}/${quizIndex}`;

            document.getElementById('quiz-card').classList.remove('flipped');
        }

        document.getElementById('quiz-card').addEventListener('click', function() {
            this.classList.toggle('flipped');
        });

        document.getElementById('correct-btn').addEventListener('click', () => {
            quizScore++;
            nextQuizQuestion();
        });

        document.getElementById('wrong-btn').addEventListener('click', () => {
            wrongAnswers.push(quizQuestions[quizIndex]);
            nextQuizQuestion();
        });

        function nextQuizQuestion() {
            quizIndex++;
            if (quizIndex < quizQuestions.length) {
                renderQuizCard();
            } else {
                showQuizResults();
            }
        }

        function showQuizResults() {
            saveQuizResults();

            document.getElementById('quiz-active').style.display = 'none';

            const percentage = Math.round((quizScore / quizQuestions.length) * 100);

            const difficultyText = quizFilters.difficulty === 'all' ? 'All Difficulties' : quizFilters.difficulty.charAt(0).toUpperCase() + quizFilters.difficulty.slice(1);
            const categoryText = quizFilters.category === 'all' ? 'All Categories' : quizFilters.category;
            const filterInfo = (quizFilters.difficulty !== 'all' || quizFilters.category !== 'all')
                ? `<p style="text-align: center; opacity: 0.8; margin-bottom: 20px;">${difficultyText} • ${categoryText}</p>`
                : '';

            let resultsHTML = `
                <div class="results-screen">
                    <div class="results-score">${quizScore}/${quizQuestions.length}</div>
                    <p style="text-align: center; font-size: 1.3rem; margin-bottom: 10px;">
                        ${percentage}% Correct
                    </p>
                    ${filterInfo}

                    <div class="results-list">
            `;

            quizQuestions.forEach((q, i) => {
                const isCorrect = !wrongAnswers.includes(q);
                resultsHTML += `
                    <div class="result-item">
                        <span class="result-icon">${isCorrect ? '✓' : '✗'}</span>
                        <div class="result-question">
                            <strong>${q.question}</strong>
                            <div style="color: var(--gold); margin-top: 5px;">${q.answer}</div>
                        </div>
                    </div>
                `;
            });

            resultsHTML += `
                    </div>

                    <div class="controls">
                        ${wrongAnswers.length > 0 ?
                            '<button class="control-btn" id="review-wrong-btn">Review Wrong Answers</button>' :
                            ''}
                        <button class="control-btn" id="new-quiz-btn">Start New Quiz</button>
                        <button class="control-btn" id="back-browse-btn">Back to Browse</button>
                    </div>
                </div>
            `;

            document.getElementById('quiz-results').innerHTML = resultsHTML;
            document.getElementById('quiz-results').style.display = 'block';

            document.getElementById('new-quiz-btn')?.addEventListener('click', () => {
                document.getElementById('quiz-results').style.display = 'none';
                document.getElementById('quiz-start').style.display = 'block';
            });

            document.getElementById('back-browse-btn')?.addEventListener('click', () => {
                document.querySelector('[data-mode="browse"]').click();
                document.getElementById('quiz-results').style.display = 'none';
                document.getElementById('quiz-start').style.display = 'block';
            });

            document.getElementById('review-wrong-btn')?.addEventListener('click', () => {
                document.querySelector('[data-mode="review"]').click();
            });
        }

        function saveQuizResults() {
            const stored = JSON.parse(localStorage.getItem(STORAGE_KEYS.WRONG_ANSWERS) || '[]');
            wrongAnswers.forEach(q => {
                const existing = stored.find(sq => sq.id === q.id);
                if (existing) {
                    existing.count = (existing.count || 1) + 1;
                } else {
                    stored.push({ ...q, count: 1 });
                }
            });
            localStorage.setItem(STORAGE_KEYS.WRONG_ANSWERS, JSON.stringify(stored));

            const history = JSON.parse(localStorage.getItem(STORAGE_KEYS.QUIZ_HISTORY) || '[]');
            history.push({
                date: new Date().toISOString(),
                score: quizScore,
                total: quizQuestions.length,
                questions: quizQuestions.map(q => ({
                    id: q.id,
                    category: q.category,
                    difficulty: q.difficulty,
                    correct: !wrongAnswers.includes(q)
                }))
            });
            localStorage.setItem(STORAGE_KEYS.QUIZ_HISTORY, JSON.stringify(history));
        }

        function renderReviewMode() {
            const stored = JSON.parse(localStorage.getItem(STORAGE_KEYS.WRONG_ANSWERS) || '[]');

            if (stored.length === 0) {
                document.getElementById('review-mode').innerHTML = `
                    <div class="empty-state">
                        <h2>No Wrong Answers Yet!</h2>
                        <p>Take a quiz to see which questions you need to review.</p>
                    </div>
                `;
                return;
            }

            let reviewHTML = `
                <div class="filters" style="margin-bottom: 30px;">
                    <h2 style="font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 15px;">
                        Questions to Review (${stored.length})
                    </h2>
                    <p style="opacity: 0.9;">These are questions you've marked wrong in previous quizzes.</p>
                </div>

                <div class="card-container">
                    <div class="card" id="review-card">
                        <div class="card-face card-front">
                            <div class="badges">
                                <span class="badge category" id="review-category"></span>
                                <span class="badge" id="review-difficulty"></span>
                                <span class="badge" style="background: var(--red);" id="review-count"></span>
                            </div>
                            <p class="question-text" id="review-question"></p>
                            <p class="tap-hint">Tap to reveal answer</p>
                        </div>
                        <div class="card-face card-back">
                            <p class="answer-text" id="review-answer"></p>
                            <p class="source-text" id="review-source"></p>
                            <a href="#" class="verify-link" id="verify-review" target="_blank" rel="noopener noreferrer">
                                🔍 Verify on Google
                            </a>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="control-btn" id="review-prev">← Previous</button>
                    <button class="control-btn" id="clear-wrong-btn">Clear This Question</button>
                    <button class="control-btn" id="review-next">Next →</button>
                </div>

                <p class="progress" id="review-progress"></p>
            `;

            document.getElementById('review-mode').innerHTML = reviewHTML;

            let reviewIndex = 0;

            function renderReviewCard() {
                const q = stored[reviewIndex];
                document.getElementById('review-question').textContent = q.question;
                document.getElementById('review-category').textContent = q.category;
                document.getElementById('review-difficulty').textContent = q.difficulty;
                document.getElementById('review-difficulty').className = `badge ${q.difficulty}`;
                document.getElementById('review-count').textContent = `Missed ${q.count}x`;
                document.getElementById('review-answer').textContent = q.answer;
                document.getElementById('review-source').textContent = q.source;
                document.getElementById('review-progress').textContent =
                    `Question ${reviewIndex + 1} of ${stored.length}`;

                document.getElementById('review-card').classList.remove('flipped');
            }

            renderReviewCard();

            document.getElementById('review-card').addEventListener('click', function() {
                this.classList.toggle('flipped');
            });

            const reviewVerifyLink = document.getElementById('verify-review');
            if (reviewVerifyLink) {
                reviewVerifyLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const question = stored[reviewIndex];
                    if (question && question.question) {
                        const searchQuery = encodeURIComponent('Harry Potter ' + question.question);
                        const searchUrl = `https://www.google.com/search?q=${searchQuery}`;
                        window.open(searchUrl, '_blank', 'noopener,noreferrer');
                    }
                });
            }

            document.getElementById('review-prev').addEventListener('click', () => {
                reviewIndex = (reviewIndex - 1 + stored.length) % stored.length;
                renderReviewCard();
            });

            document.getElementById('review-next').addEventListener('click', () => {
                reviewIndex = (reviewIndex + 1) % stored.length;
                renderReviewCard();
            });

            document.getElementById('clear-wrong-btn').addEventListener('click', () => {
                stored.splice(reviewIndex, 1);
                localStorage.setItem(STORAGE_KEYS.WRONG_ANSWERS, JSON.stringify(stored));
                reviewIndex = Math.min(reviewIndex, stored.length - 1);
                renderReviewMode();
            });
        }

        function renderStatsMode() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEYS.QUIZ_HISTORY) || '[]');

            if (history.length === 0) {
                document.getElementById('stats-mode').innerHTML = `
                    <div class="empty-state">
                        <h2>No Statistics Yet</h2>
                        <p>Complete some quizzes to see your performance statistics!</p>
                    </div>
                `;
                return;
            }

            const totalQuizzes = history.length;
            const totalQuestions = history.reduce((sum, h) => sum + h.total, 0);
            const totalCorrect = history.reduce((sum, h) => sum + h.score, 0);
            const accuracy = Math.round((totalCorrect / totalQuestions) * 100);

            const byCategory = {};
            const byDifficulty = {};
            const missedQuestions = {};

            history.forEach(quiz => {
                quiz.questions.forEach(q => {
                    if (!byCategory[q.category]) {
                        byCategory[q.category] = { correct: 0, total: 0 };
                    }
                    byCategory[q.category].total++;
                    if (q.correct) byCategory[q.category].correct++;

                    if (!byDifficulty[q.difficulty]) {
                        byDifficulty[q.difficulty] = { correct: 0, total: 0 };
                    }
                    byDifficulty[q.difficulty].total++;
                    if (q.correct) byDifficulty[q.difficulty].correct++;

                    if (!q.correct) {
                        missedQuestions[q.id] = (missedQuestions[q.id] || 0) + 1;
                    }
                });
            });

            const topMissed = Object.entries(missedQuestions)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([id, count]) => {
                    const question = allQuestions.find(q => q.id == id);
                    return { question, count };
                })
                .filter(item => item.question);

            let statsHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Quizzes</div>
                        <div class="stat-value">${totalQuizzes}</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">Overall Accuracy</div>
                        <div class="stat-value">${accuracy}%</div>
                        <p style="opacity: 0.8; margin-top: 10px;">
                            ${totalCorrect} / ${totalQuestions} correct
                        </p>
                    </div>
                </div>

                <div class="stat-card" style="margin-top: 30px;">
                    <h3 style="font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 15px;">
                        Accuracy by Category
                    </h3>
                    <div class="stat-breakdown">
            `;

            Object.entries(byCategory)
                .sort((a, b) => b[1].correct / b[1].total - a[1].correct / a[1].total)
                .forEach(([cat, stats]) => {
                    const pct = Math.round((stats.correct / stats.total) * 100);
                    statsHTML += `
                        <div class="breakdown-item">
                            <span>${cat}</span>
                            <span>${pct}% (${stats.correct}/${stats.total})</span>
                        </div>
                    `;
                });

            statsHTML += `
                    </div>
                </div>

                <div class="stat-card" style="margin-top: 30px;">
                    <h3 style="font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 15px;">
                        Accuracy by Difficulty
                    </h3>
                    <div class="stat-breakdown">
            `;

            ['easy', 'medium', 'hard'].forEach(diff => {
                if (byDifficulty[diff]) {
                    const stats = byDifficulty[diff];
                    const pct = Math.round((stats.correct / stats.total) * 100);
                    statsHTML += `
                        <div class="breakdown-item">
                            <span style="text-transform: capitalize;">${diff}</span>
                            <span>${pct}% (${stats.correct}/${stats.total})</span>
                        </div>
                    `;
                }
            });

            statsHTML += `
                    </div>
                </div>
            `;

            if (topMissed.length > 0) {
                statsHTML += `
                    <div class="stat-card" style="margin-top: 30px;">
                        <h3 style="font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 15px;">
                            Most Missed Questions
                        </h3>
                        <div class="stat-breakdown">
                `;

                topMissed.forEach(item => {
                    statsHTML += `
                        <div class="breakdown-item" style="flex-direction: column; align-items: flex-start;">
                            <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px;">
                                <strong>Missed ${item.count} times</strong>
                                <span class="badge ${item.question.difficulty}" style="font-size: 0.75rem; padding: 4px 10px;">
                                    ${item.question.difficulty}
                                </span>
                            </div>
                            <div style="opacity: 0.9;">${item.question.question}</div>
                        </div>
                    `;
                });

                statsHTML += `
                        </div>
                    </div>
                `;
            }

            statsHTML += `
                <div style="text-align: center; margin-top: 40px;">
                    <button class="control-btn" id="reset-stats-btn"
                        style="background: var(--red); border-color: var(--red);">
                        Reset All Progress
                    </button>
                </div>
            `;

            document.getElementById('stats-mode').innerHTML = statsHTML;

            document.getElementById('reset-stats-btn')?.addEventListener('click', () => {
                if (confirm('Are you sure you want to reset all quiz history and wrong answers? This cannot be undone.')) {
                    localStorage.removeItem(STORAGE_KEYS.QUIZ_HISTORY);
                    localStorage.removeItem(STORAGE_KEYS.WRONG_ANSWERS);
                    renderStatsMode();
                }
            });
        }

        document.addEventListener('keydown', (e) => {
            const activeMode = document.querySelector('.mode-content.active').id;

            if (e.key === 'ArrowLeft') {
                if (activeMode === 'browse-mode') {
                    document.getElementById('prev-btn').click();
                } else if (activeMode === 'review-mode') {
                    document.getElementById('review-prev')?.click();
                }
            } else if (e.key === 'ArrowRight') {
                if (activeMode === 'browse-mode') {
                    document.getElementById('next-btn').click();
                } else if (activeMode === 'review-mode') {
                    document.getElementById('review-next')?.click();
                }
            } else if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                if (activeMode === 'browse-mode') {
                    document.getElementById('flashcard').click();
                } else if (activeMode === 'quiz-mode' && document.getElementById('quiz-active').style.display !== 'none') {
                    document.getElementById('quiz-card').click();
                } else if (activeMode === 'review-mode') {
                    document.getElementById('review-card')?.click();
                }
            }
        });

        function setupVerifyLink(linkId, getQuestionFn) {
            const link = document.getElementById(linkId);
            if (link) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const question = getQuestionFn();
                    if (question && question.question) {
                        const searchQuery = encodeURIComponent('Harry Potter ' + question.question);
                        const searchUrl = `https://www.google.com/search?q=${searchQuery}`;
                        window.open(searchUrl, '_blank', 'noopener,noreferrer');
                    }
                });
            }
        }

        setupVerifyLink('verify-browse', () => currentQuestions[currentIndex]);
        setupVerifyLink('verify-quiz', () => quizQuestions[quizIndex]);

        loadQuestions();
    </script>
</body>
</html>
